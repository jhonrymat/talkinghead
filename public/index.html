<!DOCTYPE html>
<html>

<head>
    <title>AulaViva</title>

    <!-- importar css -->
    <link rel="stylesheet" href="./css/styles.css">
    <!-- favicon -->
    <link rel="icon" type="image/png" href="favicon.png">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <meta name="description" content="AulaViva es un asistente virtual que utiliza inteligencia artificial para interactuar con los usuarios.">
    <meta name="keywords" content="AulaViva, asistente virtual, inteligencia artificial, IA, chatbot, OpenAI, Google TTS">
    <meta name="author" content="Nomaddi SAS Team">
    

    <script type="importmap">
  { "imports":
    {
      "marked": "https://cdn.jsdelivr.net/npm/marked@14.1.3/+esm",
      "three": "https://cdn.jsdelivr.net/npm/three@0.170.0/build/three.module.js/+esm",
      "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.170.0/examples/jsm/",
      "talkinghead": "./modules/talkinghead.mjs"
    }
  }
  </script>

    <script type="module">
        import { TalkingHead } from "talkinghead";
        import { marked } from 'marked';
        import { site } from './siteconfig.js'

        // API proxys
        const jwtEndpoint = "/api/jwt"; // Get JSON Web Token for Single Sign-On
        const openaiChatCompletionsProxy = "/openai/v1/chat/completions";
        const openaiModerationsProxy = "/openai/v1/moderations";
        const openaiAudioTranscriptionsProxy = "/openai/v1/audio/transcriptions";
        const googleTTSProxy = "/gtts/";

        // variables
        let head;
        let progressTimeout;
        // JSON Web Token (JWT)
        let jwtExpires = 0;
        let jwt = '';
        // Con esta variable se controla el estado del boton enviar
        // y el micr√≥fono
        let isSpeaking = false;
        // micr√≥fono
        let mediaRecorder;
        let audioChunks = [];
        // usuario
        const USER_ID = 2;



        // Get JSON Web Token
        async function jwtGet() {
            const limit = Math.round(Date.now() / 1000) + 60;
            if (jwtExpires < limit) {
                try {
                    const o = await (await fetch(jwtEndpoint, { cache: "no-store" })).json();
                    if (o && o.jwt) {
                        const b64Url = o.jwt.split('.')[1];
                        const b64 = b64Url.replace(/-/g, '+').replace(/_/g, '/');
                        const s = decodeURIComponent(window.atob(b64).split('').map((c) => {
                            return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                        }).join(''));
                        const p = JSON.parse(s);
                        jwtExpires = (p && p.exp) ? p.exp : 0;
                        jwt = o.jwt;
                    } else {
                        jwt = '';
                        jwtExpires = 0;
                    }
                } catch (e) {
                    console.error(e);
                    jwt = '';
                    jwtExpires = 0;
                }
            }
            return jwt.slice();
        }

        document.addEventListener('DOMContentLoaded', async function (e) {

            // Instantiate the class
            // NOTE: Never put your API key in a client-side code unless you know
            //       that you are the only one to have access to that code!
            const nodeAvatar = document.getElementById('avatar');
            head = new TalkingHead(nodeAvatar, {
                jwtGet: jwtGet,
                ttsEndpoint: googleTTSProxy,
                cameraZoomEnable: true,
                cameraPanEnable: true,
                cameraView: "upper",
                avatarMood: 'neutral',
                lipsyncModules: ["es"],
                lipsyncLang: "es",
                ttsVoice: "es-ES-Standard-A",
                ttsRate: 1.0,
                ttsPitch: 0,
                ttsVolume: 1.0,
            });

            let morphTimer = null;


            function errorShow(error) {
                console.error(error);
            }
            // Load and show the avatar
            const nodeLoading = document.getElementById('loading');
            try {
                // Get token
                jwt = await jwtGet();
                // Show last avatar
                // Show last avatar
                let o = {};
                let name = Object.values(site.avatars)[0].name;

                if (site.avatars.hasOwnProperty(name)) {
                    o = site.avatars[name];
                } else {
                    o = Object.values(site.avatars)[0];
                }
                await head.showAvatar(o, progressUpdate);

                // ttsLang: "es-ES",
                //     ttsVoice: "es-ES-Standard-A",
                //     lipsyncLang: 'es'
                // Set the avatar

            } catch (error) {
                errorShow(error);

                // Backup plan: show the first avatar in site config
                await head.showAvatar(Object.values(site.avatars)[0], progressUpdate);
            }



            const nodeSpeak = document.getElementById('speak');
            const textInput = document.getElementById('text');
            const micButton = document.getElementById('mic-button');


            nodeSpeak.addEventListener('click', sendMessage);

            textInput.addEventListener('keydown', function (event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    if (!isSpeaking) {
                        sendMessage();
                    }
                }
            });

            // Update progress bar
            function progressUpdate(ev) {
                const loading = document.getElementById("loading");
                const loadingTop = document.getElementById("loading-top");
                const loadingValueElements = document.querySelectorAll("#loading-value");

                if (!loading || !loadingTop) {
                    console.warn("Elementos #loading o #loading-top no encontrados.");
                    return;
                }


                if (progressTimeout) {
                    clearTimeout(progressTimeout);
                    progressTimeout = null;
                } else {
                    loading.style.display = "block";
                }

                let hideMs = 1000;

                if (ev.lengthComputable) {
                    const val = Math.min(100, Math.round((ev.loaded / ev.total) * 100));
                    loadingTop.style.clipPath = `inset(0 ${100 - val}% 0 0)`;

                    loadingValueElements.forEach(el => {
                        el.textContent = val + "%";
                    });

                    if (val < 100) hideMs = 3000;
                } else {
                    loadingTop.style.clipPath = "inset(0 0 0 0)";
                    loadingValueElements.forEach(el => {
                        el.textContent = "" + ev.loaded;
                    });
                }

                progressTimeout = setTimeout(() => {
                    loading.style.display = "none";
                    progressTimeout = null;
                }, hideMs);
            }


            function motion(action, pose, gesture, mood) {
                try {
                    head.setMood(mood || 'neutral');
                } catch (err) { }
                if (gesture && site.gestures[gesture]) {
                    head.playGesture(site.gestures[gesture].name);
                }
                if (action && site.animations[action]) {
                    head.playAnimation(site.animations[action].url, progressUpdate, site.animations[action].dur || 20);
                } else if (pose && site.poses[pose]) {
                    head.playPose(site.poses[pose].url, progressUpdate, site.poses[pose].dur || 60);
                }
            }

            async function sendMessage() {
                if (isSpeaking) return;

                try {
                    const text = textInput.value.trim();

                    if (!text) {
                        alert("Por favor ingresa un mensaje.");
                        return;
                    }

                    addMessage(text, 'user');
                    textInput.value = '';
                    isSpeaking = true;
                    nodeSpeak.disabled = true;
                    micButton.disabled = true;
                    const payload = {
                        id: USER_ID,
                        text: text,
                        tipo: "texto",
                    };

                    const response = await fetch("https://iawebhookss.agentesias.com/webhook/915d8e4c-1017-4dd1-b19d-a8b5001faaa1", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                    const result = await response.json();
                    procesarRespuestaAgente(result);

                } catch (error) {
                    console.error("Error:", error);
                    addMessage("Ocurri√≥ un error al conectar con el servidor.", 'assistant');
                    isSpeaking = false;
                    nodeSpeak.disabled = false;
                    micButton.disabled = false;
                }
            }


            // esta funci√≥n se encarga de mostrar el texto en el chat
            // y de hacer scroll al final
            function addMessage(text, sender = 'user') {
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', sender);

                if (sender === 'assistant') {
                    // Procesa con marked (markdown a HTML)
                    messageEl.innerHTML = marked.parse(text);
                } else {
                    // El usuario no necesita formato markdown (opcional)
                    messageEl.textContent = text;
                }

                const messagesContainer = document.getElementById('messages');
                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }


            // Pause animation when document is not visible
            document.addEventListener("visibilitychange", async function (ev) {
                if (document.visibilityState === "visible") {
                    head.start();
                } else {
                    head.stop();
                }
            });


            textInput.addEventListener('input', () => {
                textInput.style.height = 'auto'; // reset height
                const maxHeight = parseFloat(getComputedStyle(textInput).lineHeight) * 4;
                textInput.style.height = Math.min(textInput.scrollHeight, maxHeight) + "px";
            });

            // micr√≥fono

            document.getElementById('mic-button').addEventListener('click', async () => {

                if (mediaRecorder && mediaRecorder.state === 'recording') {
                    playBeep(600); // beep de parada
                    mediaRecorder.stop(); // Finaliza grabaci√≥n
                    return;
                }

                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];

                    mediaRecorder.onstart = () => {
                        micButton.classList.add('active');
                        playBeep(); // beep de inicio
                        startMicTimer(); // üü¢ iniciar contador
                    };

                    mediaRecorder.ondataavailable = (e) => {
                        audioChunks.push(e.data);
                    };

                    mediaRecorder.onstop = async () => {
                        micButton.classList.remove('active');
                        stopMicTimer();

                        const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                        const audioUrl = URL.createObjectURL(audioBlob);

                        mediaRecorder.stream.getTracks().forEach(track => track.stop());

                        addAudioMessage(audioUrl, 'user');

                        const formData = new FormData();
                        formData.append('id', USER_ID);
                        formData.append('tipo', 'audio');
                        formData.append('file', audioBlob, 'nota.webm');

                        micButton.disabled = true;
                        nodeSpeak.disabled = true;
                        isSpeaking = true;

                        try {
                            const response = await fetch("https://iawebhookss.agentesias.com/webhook/915d8e4c-1017-4dd1-b19d-a8b5001faaa1", {
                                method: 'POST',
                                body: formData
                            });

                            const result = await response.json();
                            procesarRespuestaAgente(result);

                        } catch (error) {
                            console.error("Error:", error);
                            addMessage("Ocurri√≥ un error al conectar con el servidor.", 'assistant');
                            isSpeaking = false;
                            micButton.disabled = false;
                            nodeSpeak.disabled = false;
                        }
                    };


                    mediaRecorder.start();
                } catch (err) {
                    alert("No se pudo acceder al micr√≥fono.");
                    console.error(err);
                }
            });


            function addAudioMessage(audioUrl, sender = 'user') {
                const messageEl = document.createElement('div');
                messageEl.classList.add('message', sender);

                const audio = document.createElement('audio');
                audio.src = audioUrl;
                audio.controls = true;

                messageEl.appendChild(audio);
                const messagesContainer = document.getElementById('messages');
                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            // Funci√≥n para reproducir un beep

            function playBeep(freq = 1000, duration = 150, volume = 0.1) {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();

                osc.type = 'sine';
                osc.frequency.value = freq;

                gain.gain.value = volume; // üîâ volumen bajo (0.0 a 1.0)
                osc.connect(gain);
                gain.connect(ctx.destination);

                osc.start();
                setTimeout(() => {
                    osc.stop();
                    ctx.close();
                }, duration);
            }


            let micTimerInterval;
            let micSeconds = 0;

            function startMicTimer() {
                micSeconds = 0;
                const micTimer = document.getElementById('mic-timer');
                micTimer.style.display = 'inline';
                micTimer.textContent = formatTime(micSeconds);

                micTimerInterval = setInterval(() => {
                    micSeconds++;
                    micTimer.textContent = formatTime(micSeconds);
                }, 1000);
            }

            function stopMicTimer() {
                clearInterval(micTimerInterval);
                document.getElementById('mic-timer').style.display = 'none';
            }

            function formatTime(seconds) {
                const min = String(Math.floor(seconds / 60)).padStart(2, '0');
                const sec = String(seconds % 60).padStart(2, '0');
                return `‚è± ${min}:${sec}`;
            }
            function procesarRespuestaAgente(result) {
                const mensaje = result.respuesta || result.response;

                if (mensaje) {
                    head.speakText(mensaje);
                    addMessage(mensaje, 'assistant');
                }

                if (result.motion) {
                    const { action, stillpose, gesture, mood } = result.motion;
                    motion(action, stillpose, gesture, mood);
                }

                setTimeout(() => {
                    isSpeaking = false;
                    nodeSpeak.disabled = false;
                    micButton.disabled = false;
                }, 4000); // espera 4 segundos como tiempo estimado
            }


        });



    </script>
</head>

<body>
    <div id="container">
        <div id="loading">
            <div id="loading-back"></div>
            <div id="loading-top"></div>
            <div id="loading-value"></div>
        </div>
        <div id="avatar"></div>

        <div id="chat-container">
            <div id="messages">
            </div>

            <div id="controls">
                <textarea id="text" rows="1" placeholder="Escribe tu mensaje aqu√≠..."></textarea>
                <span id="mic-timer" style="display:none; margin-left: 10px; font-size: 14px; color: red;">‚è±
                    00:00</span>
                <button id="mic-button" class="circle-button mic">
                    <svg viewBox="-2 -2 28 28" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" clip-rule="evenodd"
                            d="M9 4C9 2.34315 10.3431 1 12 1C13.6569 1 15 2.34315 15 4V12C15 13.6569 13.6569 15 12 15C10.3431 15 9 13.6569 9 12V4ZM13 4V12C13 12.5523 12.5523 13 12 13C11.4477 13 11 12.5523 11 12V4C11 3.44772 11.4477 3 12 3C12.5523 3 13 3.44772 13 4Z"
                            fill="currentColor" />
                        <path
                            d="M18 12C18 14.973 15.8377 17.441 13 17.917V21H17V23H7V21H11V17.917C8.16229 17.441 6 14.973 6 12V9H8V12C8 14.2091 9.79086 16 12 16C14.2091 16 16 14.2091 16 12V9H18V12Z"
                            fill="currentColor" />
                    </svg>
                </button>
                <button id="speak" class="circle-button send">
                    <svg viewBox="0 0 24 24" width="24" height="24">
                        <path fill="currentColor" d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                    </svg>
                </button>
            </div>
        </div>
    </div>
</body>

</html>